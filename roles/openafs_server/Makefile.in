# Copyright (c) 2019-2020 Sine Nomine Associates

.PHONY: help lint test distclean

COOK=@COOKIECUTTER@ \
   --no-input -f -o molecule \
   @TOPDIR@/cookiecutter/molecule-scenario @DRIVER_OPTIONS@ \
   instance_name=@INSTANCE_PREFIX@server \
   with_server=yes

help:
	@echo "usage: make <target>"
	@echo ""
	@echo "targets:"
	@echo "  lint        run lint checks"
	@echo "  test        run molecule scenarios"
	@echo "  molecule    generate molecule scenarios"
	@echo "  clean       remove molecule scenarios"
	@echo ""

lint:
	pyflakes library/*.py
	yamllint .
	ansible-lint .

test: molecule
	molecule test --all

molecule: Makefile
	$(COOK) name=default
	$(COOK) name=cen7                os=centos7
	$(COOK) name=cen7-selinux        os=centos7             selinux_mode=enforcing
	$(COOK) name=cen7-c              os=centos7             with_client=yes
	$(COOK) name=cen7-rpm            os=centos7 im=packages
	$(COOK) name=cen7-rpm-c          os=centos7 im=packages with_client=yes
	$(COOK) name=cen7-bdist          os=centos7 im=bdist
	$(COOK) name=cen7-transarc       os=centos7 im=bdist    bdist_flavor=transarc
	$(COOK) name=cen7-bdist-c        os=centos7 im=bdist    with_client=yes
	$(COOK) name=cen7-scm            os=centos7 im=scm
	$(COOK) name=cen7-scm-c          os=centos7 im=scm      with_client=yes
	$(COOK) name=cen8                os=centos8
	$(COOK) name=cen8-c              os=centos8             with_client=yes
	$(COOK) name=cen8-rpm            os=centos8 im=packages
	$(COOK) name=cen8-bdist          os=centos8 im=bdist
	$(COOK) name=cen8-transarc       os=centos8 im=bdist    bdist_flavor=transarc
	$(COOK) name=cen8-scm            os=centos8 im=scm
	$(COOK) name=cen8-scm-c          os=centos8 im=scm      with_client=yes
	$(COOK) name=deb9                os=debian9
	$(COOK) name=deb9-c              os=debian9             with_client=yes
	$(COOK) name=deb9-bdist          os=debian9 im=bdist
	$(COOK) name=deb9-bdist-c        os=debian9 im=bdist    with_client=yes
	$(COOK) name=deb9-scm            os=debian9 im=scm
	$(COOK) name=deb9-scm-c          os=debian9 im=scm      with_client=yes
	$(COOK) name=deb10               os=debian10
	$(COOK) name=deb10-c             os=debian10            with_client=yes
	$(COOK) name=deb10-bdist         os=debian10 im=bdist
	$(COOK) name=deb10-bdist-c       os=debian10 im=bdist   with_client=yes
	$(COOK) name=deb10-scm           os=debian10 im=scm
	$(COOK) name=deb10-scm-c         os=debian10 im=scm     with_client=yes
	touch molecule

clean:
	rm -rf molecule
